<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Grade de Horários Movom</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
    --lilas:#6a5acd;
    --ciano:#4fc3f7;
    --bg:#f7f5ff;
    --card:#ffffff;
}
body{
    font-family:Poppins, Arial, sans-serif;
    background:var(--bg);
    padding:20px;
}
h2,h3{
    text-align:center;
    color:var(--lilas);
}
.controls{
    display:flex;
    justify-content:center;
    gap:12px;
    margin-bottom:16px;
}
select{
    padding:8px;
    border-radius:8px;
}
.container-card{
    background:#fff;
    border-radius:12px;
    padding:14px;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-bottom:24px;
}
thead th{
    background:linear-gradient(90deg,var(--lilas),var(--ciano));
    color:#fff;
    padding:10px;
}
td{
    border-bottom:1px solid #eee;
    padding:10px;
}
.horario-cell{
    width:90px;
    text-align:center;
    font-weight:600;
}
.instrutor-box{
    border-left:4px solid var(--lilas);
    padding:8px;
    border-radius:6px;
}
.alunos-box{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:6px;
}
.aluno-row{
    display:flex;
    gap:6px;
}
.aluno-row input{
    flex:1;
    padding:6px;
}
.btn{
    border:none;
    border-radius:6px;
    padding:6px 10px;
    cursor:pointer;
}
.btn-add{background:var(--ciano);color:#fff;}
.btn-remove{background:#ff6b8a;color:#fff;}
.small{font-size:12px;}
</style>
</head>

<body>

<div class="container-card">
    <div class="controls">
        <select id="diaSemana">
            <option value="todos">Todos</option>
            <option>Segunda-feira</option>
            <option>Terça-feira</option>
            <option>Quarta-feira</option>
            <option>Quinta-feira</option>
            <option>Sexta-feira</option>
            <option>Sábado</option>
        </select>
    </div>

    <h2>Grade de Horários Movom</h2>
    <div id="container"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyASKbZ204Yls9IU3HenHTsHwqgbpotUga0",
  authDomain: "horariomovom.firebaseapp.com",
  databaseURL: "https://horariomovom-default-rtdb.firebaseio.com",
  projectId: "horariomovom",
  storageBucket: "horariomovom.firebasestorage.app",
  messagingSenderId: "827903999846",
  appId: "1:827903999846:web:e2495e75cc0f8b4ad852a7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const gradeRef = ref(db, "gradeHorarios");

const MAX_ALUNOS = 5;
const container = document.getElementById("container");
const selectDia = document.getElementById("diaSemana");

let saveTimer = null;
let isTyping = false;

function gerarHorarios(i,f){
    const a=[];
    for(let h=i;h<=f;h++) a.push(String(h).padStart(2,"0")+":00");
    return a;
}

const semana = [
 {dia:"Segunda-feira",horarios:gerarHorarios(7,19)},
 {dia:"Terça-feira",horarios:gerarHorarios(7,19)},
 {dia:"Quarta-feira",horarios:gerarHorarios(7,19)},
 {dia:"Quinta-feira",horarios:gerarHorarios(7,19)},
 {dia:"Sexta-feira",horarios:gerarHorarios(7,18)},
 {dia:"Sábado",horarios:gerarHorarios(7,11)}
];

function salvarFirebase(){
    isTyping = true;
    clearTimeout(saveTimer);

    saveTimer = setTimeout(() => {
        const data = {};

        document.querySelectorAll("table[data-dia]").forEach(table=>{
            const dia = table.dataset.dia;
            data[dia] = [];

            table.querySelectorAll("tbody tr").forEach(tr=>{
                const horario = tr.querySelector(".horario-cell").textContent;
                const instr1 = tr.querySelector(".i1")?.value || "";
                const instr2 = tr.querySelector(".i2")?.value || "";
                const alunos1 = [...tr.querySelectorAll(".a1 input")].map(i=>i.value);
                const alunos2 = [...tr.querySelectorAll(".a2 input")].map(i=>i.value);

                data[dia].push({ horario, instr1, instr2, alunos1, alunos2 });
            });
        });

        set(gradeRef, data);
        isTyping = false;
    }, 300);
}

function criarAluno(nome){
    const d=document.createElement("div");
    d.className="aluno-row";
    const i=document.createElement("input");
    i.value=nome||"";
    i.oninput=salvarFirebase;
    const b=document.createElement("button");
    b.textContent="X";
    b.className="btn btn-remove small";
    b.onclick=()=>{d.remove();salvarFirebase();};
    d.append(i,b);
    return d;
}

function criarLinha(l){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="horario-cell">${l.horario}</td>
      <td>
        <input class="i1" value="${l.instr1||""}">
        <div class="alunos-box a1"></div>
        <button class="btn btn-add small">+ Aluno</button>
      </td>
      <td>
        <input class="i2" value="${l.instr2||""}">
        <div class="alunos-box a2"></div>
        <button class="btn btn-add small">+ Aluno</button>
      </td>
      <td></td>`;
    
    tr.querySelectorAll("input").forEach(i=>i.oninput=salvarFirebase);
    l.alunos1?.forEach(a=>tr.querySelector(".a1").appendChild(criarAluno(a)));
    l.alunos2?.forEach(a=>tr.querySelector(".a2").appendChild(criarAluno(a)));

    tr.querySelectorAll(".btn-add")[0].onclick=()=>{
        if(tr.querySelector(".a1").children.length<MAX_ALUNOS){
            tr.querySelector(".a1").appendChild(criarAluno(""));
            salvarFirebase();
        }
    };
    tr.querySelectorAll(".btn-add")[1].onclick=()=>{
        if(tr.querySelector(".a2").children.length<MAX_ALUNOS){
            tr.querySelector(".a2").appendChild(criarAluno(""));
            salvarFirebase();
        }
    };
    return tr;
}

function render(data){
    container.innerHTML="";
    semana.forEach(d=>{
        const h3=document.createElement("h3");
        h3.textContent=d.dia;

        const table=document.createElement("table");
        table.dataset.dia=d.dia;
        table.innerHTML="<thead><tr><th>Horário</th><th>Instrutor 1</th><th>Instrutor 2</th><th></th></tr></thead>";
        const tb=document.createElement("tbody");

        (data?.[d.dia] || d.horarios.map(h=>({horario:h,alunos1:[],alunos2:[]})))
            .forEach(l=>tb.appendChild(criarLinha(l)));

        table.appendChild(tb);
        container.append(h3,table);
    });
}

onValue(gradeRef, snap=>{
    if(isTyping) return;
    render(snap.val());
});

selectDia.onchange=()=>{
    const v=selectDia.value;
    document.querySelectorAll("h3,table").forEach(el=>{
        if(v==="todos") el.style.display="";
        else if(el.tagName==="H3") el.style.display=el.textContent===v?"":"none";
        else el.style.display=el.previousElementSibling.textContent===v?"":"none";
    });
};
</script>

</body>
</html>
