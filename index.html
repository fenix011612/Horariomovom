<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Grade de Hor치rios Movom</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Poppins,Arial,sans-serif;
  background:#f7f5ff;
  padding:20px;
}
h2,h3{color:#6a5acd;text-align:center}
table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:24px;
  background:#fff;
}
th{
  background:#6a5acd;
  color:#fff;
  padding:8px;
}
td{
  border:1px solid #eee;
  padding:6px;
  vertical-align:top;
}
.horario{width:80px;font-weight:600;text-align:center}
input{width:100%;padding:5px;margin:3px 0}
button{
  padding:4px 8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.add{background:#4fc3f7;color:#fff}
.rem{background:#ff6b8a;color:#fff}
.status{
  text-align:center;
  font-size:13px;
  margin-bottom:10px;
  color:#555;
}
</style>
</head>

<body>

<h2>Grade de Hor치rios Movom</h2>
<div class="status" id="status">Conectando ao Firebase...</div>
<div id="container"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* 游댮 COLOQUE SEU CONFIG AQUI 游댮 */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  databaseURL: "SUA_DATABASE_URL",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "gradeHorarios/movom");

/* CONTROLE DE LOOP */
const sessionId = Math.random().toString(36).slice(2);
let bloqueioRemoto = false;
let ultimoSave = 0;

/* ESTRUTURA */
const semana = [
  {dia:"Segunda-feira",h:7,f:20},
  {dia:"Ter칞a-feira",h:7,f:20},
  {dia:"Quarta-feira",h:7,f:20},
  {dia:"Quinta-feira",h:7,f:20},
  {dia:"Sexta-feira",h:7,f:19},
  {dia:"S치bado",h:7,f:12}
];

const container = document.getElementById("container");
const statusEl = document.getElementById("status");

/* CRIAR INTERFACE */
function criarTudo(dados){
  container.innerHTML="";
  semana.forEach(d=>{
    const h3=document.createElement("h3");
    h3.textContent=d.dia;
    container.appendChild(h3);

    const table=document.createElement("table");
    const thead=document.createElement("thead");
    thead.innerHTML="<tr><th>Hor치rio</th><th>Instrutor</th><th>Alunos</th></tr>";
    table.appendChild(thead);

    const tbody=document.createElement("tbody");

    for(let h=d.h;h<d.f;h++){
      const horario=`${String(h).padStart(2,"0")}:00`;
      const linha=dados?.[d.dia]?.[horario]||{instr:"",alunos:[]};

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="horario">${horario}</td>
        <td><input value="${linha.instr}"></td>
        <td></td>
      `;

      const alunosTd=tr.children[2];
      linha.alunos.forEach(a=>{
        alunosTd.appendChild(criarAluno(a));
      });

      const btn=document.createElement("button");
      btn.textContent="+ Aluno";
      btn.className="add";
      btn.onclick=()=>{
        alunosTd.appendChild(criarAluno(""));
        salvar();
      };
      alunosTd.appendChild(btn);

      tr.querySelectorAll("input").forEach(i=>{
        i.addEventListener("input", salvar);
      });

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    container.appendChild(table);
  });
}

/* ALUNO */
function criarAluno(nome){
  const div=document.createElement("div");
  const i=document.createElement("input");
  i.value=nome;
  i.addEventListener("input", salvar);
  const b=document.createElement("button");
  b.textContent="X";
  b.className="rem";
  b.onclick=()=>{div.remove();salvar();}
  div.appendChild(i);
  div.appendChild(b);
  return div;
}

/* COLETAR */
function coletar(){
  const dados={};
  document.querySelectorAll("table").forEach((table,i)=>{
    const dia=semana[i].dia;
    dados[dia]={};
    table.querySelectorAll("tbody tr").forEach(tr=>{
      const h=tr.children[0].textContent;
      const instr=tr.children[1].querySelector("input").value;
      const alunos=[...tr.children[2].querySelectorAll("input")].map(i=>i.value);
      dados[dia][h]={instr,alunos};
    });
  });
  return dados;
}

/* SALVAR */
function salvar(){
  if(bloqueioRemoto) return;
  clearTimeout(window._t);
  window._t=setTimeout(()=>{
    ultimoSave=Date.now();
    set(dbRef,{sessionId,data:coletar()});
    statusEl.textContent="Salvo";
  },300);
}

/* OUVIR */
onValue(dbRef,snap=>{
  const v=snap.val();
  if(!v) return;
  if(v.sessionId===sessionId) return;
  if(Date.now()-ultimoSave<500) return;

  bloqueioRemoto=true;
  criarTudo(v.data);
  setTimeout(()=>bloqueioRemoto=false,300);
  statusEl.textContent="Sincronizado";
});

/* INICIAR */
criarTudo({});
statusEl.textContent="Conectado ao Firebase";
</script>

</body>
</html>
