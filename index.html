<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Grade de Horários Movom</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
    --lilas:#6a5acd;
    --ciano:#4fc3f7;
    --bg:#f7f5ff;
}
body{
    font-family:Poppins, Arial, sans-serif;
    background:var(--bg);
    padding:20px;
}
h2,h3{
    text-align:center;
    color:var(--lilas);
}
.container-card{
    background:#fff;
    border-radius:12px;
    padding:14px;
}
.controls{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-bottom:15px;
}
select{
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-bottom:24px;
}
thead th{
    background:linear-gradient(90deg,var(--lilas),var(--ciano));
    color:#fff;
    padding:10px;
}
td{
    border-bottom:1px solid #eee;
    padding:10px;
    vertical-align:top;
}
.horario-cell{
    width:90px;
    text-align:center;
    font-weight:600;
}
.alunos-box{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:6px;
}
.aluno-row{
    display:flex;
    gap:6px;
}
.aluno-row input{
    flex:1;
    padding:6px;
}
.btn{
    border:none;
    border-radius:6px;
    padding:6px 10px;
    cursor:pointer;
}
.btn-add{background:var(--ciano);color:#fff;}
.btn-remove{background:#ff6b8a;color:#fff;}
.small{font-size:12px;}
</style>
</head>

<body>

<div class="container-card">
    <h2>Grade de Horários Movom</h2>

    <div class="controls">
        <select id="filtroDia">
            <option value="Todos">Todos os dias</option>
            <option>Segunda-feira</option>
            <option>Terça-feira</option>
            <option>Quarta-feira</option>
            <option>Quinta-feira</option>
            <option>Sexta-feira</option>
            <option>Sábado</option>
        </select>
    </div>

    <div id="container"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyASKbZ204Yls9IU3HenHTsHwqgbpotUga0",
  authDomain: "horariomovom.firebaseapp.com",
  databaseURL: "https://horariomovom-default-rtdb.firebaseio.com",
  projectId: "horariomovom"
});

const db = getDatabase(app);
const gradeRef = ref(db,"gradeHorarios");

const MAX_ALUNOS = 5;
const container = document.getElementById("container");
const filtroDia = document.getElementById("filtroDia");

let isTyping = false;

function gerarHorarios(inicio,fim){
    const arr=[];
    for(let h=inicio;h<=fim;h++) arr.push(String(h).padStart(2,"0")+":00");
    return arr;
}

const semana = [
 {dia:"Segunda-feira", horarios: gerarHorarios(7,19)},
 {dia:"Terça-feira",  horarios: gerarHorarios(7,19)},
 {dia:"Quarta-feira", horarios: gerarHorarios(7,19)},
 {dia:"Quinta-feira", horarios: gerarHorarios(7,19)},
 {dia:"Sexta-feira",  horarios: gerarHorarios(7,18)},
 {dia:"Sábado",       horarios: gerarHorarios(7,10)}
];

function salvarFirebase(){
    const data={};
    document.querySelectorAll("table[data-dia]").forEach(t=>{
        const dia=t.dataset.dia;
        data[dia]=[];
        t.querySelectorAll("tbody tr").forEach(tr=>{
            data[dia].push({
                horario:tr.querySelector(".horario-cell").textContent,
                instr1:tr.querySelector(".i1").value,
                instr2:tr.querySelector(".i2").value,
                alunos1:[...tr.querySelectorAll(".a1 input")].map(i=>i.value),
                alunos2:[...tr.querySelectorAll(".a2 input")].map(i=>i.value)
            });
        });
    });
    set(gradeRef,data);
}

function criarAluno(nome){
    const d=document.createElement("div");
    d.className="aluno-row";
    const i=document.createElement("input");
    i.value=nome||"";
    i.onfocus=()=>isTyping=true;
    i.onblur=()=>{isTyping=false;salvarFirebase();};
    const b=document.createElement("button");
    b.textContent="X";
    b.className="btn btn-remove small";
    b.onclick=()=>{d.remove();salvarFirebase();};
    d.append(i,b);
    return d;
}

function criarLinha(l){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="horario-cell">${l.horario}</td>
      <td>
        <input class="i1">
        <div class="alunos-box a1"></div>
        <button class="btn btn-add small">+ Aluno</button>
      </td>
      <td>
        <input class="i2">
        <div class="alunos-box a2"></div>
        <button class="btn btn-add small">+ Aluno</button>
      </td>`;

    tr.querySelector(".i1").value=l.instr1||"";
    tr.querySelector(".i2").value=l.instr2||"";

    tr.querySelectorAll("input").forEach(i=>{
        i.onfocus=()=>isTyping=true;
        i.onblur=()=>{isTyping=false;salvarFirebase();};
    });

    l.alunos1?.forEach(a=>tr.querySelector(".a1").appendChild(criarAluno(a)));
    l.alunos2?.forEach(a=>tr.querySelector(".a2").appendChild(criarAluno(a)));

    tr.querySelectorAll(".btn-add")[0].onclick=()=>{
        if(tr.querySelector(".a1").children.length<MAX_ALUNOS){
            tr.querySelector(".a1").appendChild(criarAluno(""));
            salvarFirebase();
        }
    };
    tr.querySelectorAll(".btn-add")[1].onclick=()=>{
        if(tr.querySelector(".a2").children.length<MAX_ALUNOS){
            tr.querySelector(".a2").appendChild(criarAluno(""));
            salvarFirebase();
        }
    };
    return tr;
}

function render(data){
    if(isTyping) return;

    container.innerHTML="";
    semana.forEach(d=>{
        const h3=document.createElement("h3");
        h3.textContent=d.dia;

        const table=document.createElement("table");
        table.dataset.dia=d.dia;
        table.innerHTML="<thead><tr><th>Horário</th><th>Instrutor 1</th><th>Instrutor 2</th></tr></thead>";
        const tb=document.createElement("tbody");

        const salvos = data?.[d.dia] || [];
        d.horarios.forEach(h=>{
            const encontrado = salvos.find(l=>l.horario===h);
            tb.appendChild(criarLinha(encontrado || {horario:h,alunos1:[],alunos2:[]}));
        });

        table.appendChild(tb);
        container.append(h3,table);
    });

    filtrarDia();
}

function filtrarDia(){
    const v=filtroDia.value;
    document.querySelectorAll("h3, table").forEach(el=>{
        if(v==="Todos") el.style.display="";
        else if(el.tagName==="H3") el.style.display=el.textContent===v?"":"none";
        else el.style.display=el.dataset.dia===v?"":"none";
    });
}

filtroDia.onchange=filtrarDia;
onValue(gradeRef,s=>render(s.val()));
</script>

</body>
</html>
